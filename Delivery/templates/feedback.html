{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Customer Feedback</h2>
    </div>
    <div class="card-body">
        {% if feedback %}
        <div class="row">
            {% for item in feedback %}
            <div class="col-4 mb-4">
                <div style="background-color: #f8f9fa; padding: 1.5rem; border-radius: 8px; height: 100%;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                        <h4 style="margin: 0;">{{ item.CustomerName }}</h4>
                        <div>
                            {% for i in range(5) %}
                            <span style="color: {% if i < item.Rating %}gold{% else %}lightgray{% endif %};">â˜…</span>
                            {% endfor %}
                        </div>
                    </div>
                    <p style="margin-bottom: 1rem;">{{ item.Comment }}</p>
                    <small class="text-muted">{{ item.Date }}</small>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p>No feedback received yet.</p>
        {% endif %}
    </div>
</div>

{% if feedback %}
<div class="card mt-4">
    <div class="card-header">
        <h2 class="card-title">Feedback Statistics</h2>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-6">
                <div class="chart-container">
                    <canvas id="ratingChart"></canvas>
                </div>
            </div>
            <div class="col-6">
                <div class="chart-container">
                    <canvas id="feedbackTrend"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof Chart !== 'undefined') {
            // Rating distribution chart
            const ratingCtx = document.getElementById('ratingChart').getContext('2d');
            const ratingData = {
                1: 0, 2: 0, 3: 0, 4: 0, 5: 0
            };
            
            {% for item in feedback %}
            ratingData[{{ item.Rating }}]++;
            {% endfor %}
            
            new Chart(ratingCtx, {
                type: 'bar',
                data: {
                    labels: ['1 Star', '2 Stars', '3 Stars', '4 Stars', '5 Stars'],
                    datasets: [{
                        label: 'Number of Ratings',
                        data: Object.values(ratingData),
                        backgroundColor: [
                            '#dc3545',
                            '#fd7e14',
                            '#ffc107',
                            '#28a745',
                            '#4a6bff'
                        ]
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            stepSize: 1
                        }
                    }
                }
            });
            
            // Feedback trend chart (group by date)
            const trendCtx = document.getElementById('feedbackTrend').getContext('2d');
            const feedbackByDate = {};
            
            {% for item in feedback %}
            const date = '{{ item.Date }}'.split(' ')[0];
            feedbackByDate[date] = feedbackByDate[date] || {count: 0, total: 0};
            feedbackByDate[date].count++;
            feedbackByDate[date].total += {{ item.Rating }};
            {% endfor %}
            
            const dates = Object.keys(feedbackByDate).sort();
            const avgRatings = dates.map(date => (feedbackByDate[date].total / feedbackByDate[date].count).toFixed(1));
            
            new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Average Rating',
                        data: avgRatings,
                        borderColor: '#4a6bff',
                        backgroundColor: 'rgba(74, 107, 255, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    scales: {
                        y: {
                            min: 1,
                            max: 5,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }
    });
</script>
{% endif %}
{% endblock %}